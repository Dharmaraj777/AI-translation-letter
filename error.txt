# pdf_processor.py

import io
from typing import Optional

import fitz  # PyMuPDF

from spanish_translator_logger import logger
from spanish_translator_oai_client import OaiClient


class PdfProcessor:
    """
    PDF translator (vision-based, text-first).

    Strategy:
    - For each page in the original PDF:
        1) Render the page as a PNG image.
        2) Call Azure OpenAI vision via OaiClient.translate_image_to_language(...)
           to get a FULL Spanish version of that page's text (ideally with structure).
        3) Build a NEW PDF:
            - One blank page per original page.
            - Place the translated text in a text box with automatic wrapping.

    This does NOT preserve the original brochure design (colors/background),
    but produces a clean Spanish PDF with content in the correct page order.
    """

    def __init__(self, oai_client: OaiClient, dpi: int = 200):
        self.oai_client = oai_client
        self.dpi = dpi

    # -------------------------------------------------
    # Helper: render one page to PNG bytes
    # -------------------------------------------------
    def _page_to_png_bytes(self, page: fitz.Page) -> bytes:
        """
        Render a PDF page to PNG bytes at the configured DPI.
        """
        zoom = self.dpi / 72.0
        mat = fitz.Matrix(zoom, zoom)
        pix = page.get_pixmap(matrix=mat, alpha=False)
        return pix.tobytes("png")

    # -------------------------------------------------
    # Helper: add one translated page to output PDF
    # -------------------------------------------------
    def _add_translated_page(
        self,
        out_doc: fitz.Document,
        page_rect: fitz.Rect,
        translated_text: str,
        page_idx: int,
    ) -> None:
        """
        Create a new page with the same size as the original and place the
        translated text inside a margin box using insert_textbox.
        """
        new_page = out_doc.new_page(width=page_rect.width, height=page_rect.height)

        if not translated_text:
            # Nothing to render; leave it blank (or add a small note if you want)
            return

        # Define margins (roughly half an inch)
        margin_x = 36
        margin_y = 36

        text_rect = fitz.Rect(
            page_rect.x0 + margin_x,
            page_rect.y0 + margin_y,
            page_rect.x1 - margin_x,
            page_rect.y1 - margin_y,
        )

        try:
            # Draw the whole page text. PyMuPDF will wrap it within the box.
            new_page.insert_textbox(
                text_rect,
                translated_text,
                fontsize=11,
                fontname="helv",  # built-in font
                color=(0, 0, 0),
                align=0,  # left-aligned
            )
        except Exception as e:
            logger.error(
                f"[pdf-vision] Failed to insert translated text on page {page_idx + 1}: {e}"
            )

    # -------------------------------------------------
    # Public entrypoint
    # -------------------------------------------------
    def translate_document(
        self,
        filename: str,
        content_bytes: bytes,
        target_language: Optional[str] = None,
        target_dialect: Optional[str] = None,
    ) -> bytes:
        logger.info(f"Translating PDF via vision (page-by-page): {filename}")

        src_doc = fitz.open(stream=content_bytes, filetype="pdf")
        out_doc = fitz.open()

        try:
            num_pages = len(src_doc)
            logger.info(f"[pdf-vision] PDF has {num_pages} pages.")

            for page_idx in range(num_pages):
                page = src_doc[page_idx]
                logger.info(f"[pdf-vision] Processing page {page_idx + 1}/{num_pages}.")

                # 1) Render page to PNG
                try:
                    png_bytes = self._page_to_png_bytes(page)
                except Exception as e:
                    logger.error(f"[pdf-vision] Failed to render page {page_idx + 1}: {e}")
                    # Create a blank page indicating error, instead of crashing pipeline
                    self._add_translated_page(
                        out_doc,
                        page.rect,
                        f"[Error rendering original page {page_idx + 1}]",
                        page_idx,
                    )
                    continue

                # 2) Call vision model for Spanish translation
                try:
                    translated_text = self.oai_client.translate_image_to_language(
                        png_bytes,
                        content_type="image/png",
                        target_language=target_language,
                        target_dialect=target_dialect,
                    )
                    if translated_text is None:
                        translated_text = ""
                except Exception as e:
                    logger.error(
                        f"[pdf-vision] Vision translation failed for page {page_idx + 1}: {e}"
                    )
                    translated_text = ""

                # Log a small sample for debugging
                if translated_text:
                    logger.info(
                        f"[pdf-vision sample] page {page_idx + 1}: "
                        f"{translated_text[:120]!r}"
                    )
                else:
                    logger.warning(
                        f"[pdf-vision] Empty translation for page {page_idx + 1}; "
                        f"creating blank translated page."
                    )

                # 3) Add translated text page to output PDF
                self._add_translated_page(
                    out_doc,
                    page.rect,
                    translated_text,
                    page_idx,
                )

            # Serialize translated PDF to bytes
            buf = io.BytesIO()
            out_doc.save(buf)
            buf.seek(0)
            return buf.read()

        finally:
            src_doc.close()
            out_doc.close()


#========================================
def translate_image_to_language(self, image_bytes, content_type, target_language, target_dialect):
    # ... build messages
    system_message = (
        "You are a professional translator. "
        "You see a page from a brochure or document as an image. "
        "Your job is to translate ALL visible readable text into {language}, "
        "keeping the logical order and structure. "
        "Use plain text with line breaks to represent headings, bullet lists, "
        "and separate sections clearly. Do not skip fine print or footers."
    )

    # user message: include the image
    # image part uses the data: URL that the client builds internally
    # ...
