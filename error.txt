# pdf_processor.py
import io
from typing import Optional

import fitz  # PyMuPDF

from spanish_translator_logger import logger
from spanish_translator_oai_client import OaiClient


class PdfProcessor:
    """
    PDF translator (vision-based).

    Strategy:
    - For each page:
        1) Render page to a PNG image.
        2) Call Azure OpenAI vision via OaiClient.translate_image_to_language(...)
           to get a FULL Spanish version of the page (ideally in Markdown / rich text).
        3) Build a NEW PDF:
            - One blank page per original page.
            - Draw the translated text in a text box with automatic wrapping.

    This does NOT preserve the original background design, but produces a clean
    Spanish PDF with the content in order.
    """

    def __init__(self, oai_client: OaiClient, dpi: int = 200):
        self.oai_client = oai_client
        self.dpi = dpi

    # -----------------------------
    # Helper: render page to PNG bytes
    # -----------------------------
    def _page_to_png_bytes(self, page: fitz.Page) -> bytes:
        # Render with a zoom based on DPI for better OCR
        zoom = self.dpi / 72.0
        mat = fitz.Matrix(zoom, zoom)
        pix = page.get_pixmap(matrix=mat, alpha=False)
        return pix.tobytes("png")

    # -----------------------------
    # Helper: layout translated text on a new page
    # -----------------------------
    def _add_translated_page(
        self,
        new_doc: fitz.Document,
        page_rect: fitz.Rect,
        translated_text: str,
        page_idx: int,
    ) -> None:
        """
        Create a new page matching the original size and place translated_text
        inside a margin box using insert_textbox (auto-wrap).
        """
        new_page = new_doc.new_page(width=page_rect.width, height=page_rect.height)

        # Page margins
        margin_x = 36  # half inch-ish
        margin_y = 36

        text_rect = fitz.Rect(
            page_rect.x0 + margin_x,
            page_rect.y0 + margin_y,
            page_rect.x1 - margin_x,
            page_rect.y1 - margin_y,
        )

        # Optional: small header at top to show this is translated output
        if page_idx == 0:
            header_rect = fitz.Rect(
                page_rect.x0 + margin_x,
                page_rect.y0 + margin_y,
                page_rect.x1 - margin_x,
                page_rect.y0 + margin_y + 30,
            )
            try:
                new_page.insert_textbox(
                    header_rect,
                    "=== TRANSLATED PDF (SPANISH) ===",
                    fontsize=12,
                    fontname="helv",
                    color=(0, 0, 0),
                    align=1,  # center
                )
                # Shift main text down a bit
                text_rect.y0 += 30
            except Exception as e:
                logger.error(f"[pdf] Failed to insert header on page 1: {e}")

        if not translated_text:
            return

        try:
            # Draw the whole page text. PyMuPDF will wrap within the box.
            new_page.insert_textbox(
                text_rect,
                translated_text,
                fontsize=11,
                fontname="helv",
                color=(0, 0, 0),
                align=0,  # left
            )
        except Exception as e:
            logger.error(f"[pdf] Failed to insert translated text on page {page_idx + 1}: {e}")

    # -----------------------------
    # Public entrypoint
    # -----------------------------
    def translate_document(
        self,
        filename: str,
        content_bytes: bytes,
        target_language: Optional[str] = None,
        target_dialect: Optional[str] = None,
    ) -> bytes:
        logger.info(f"Translating PDF via vision (page-by-page): {filename}")

        # Open original PDF from bytes
        src_doc = fitz.open(stream=content_bytes, filetype="pdf")

        # New PDF that will hold only Spanish text
        out_doc = fitz.open()

        try:
            num_pages = len(src_doc)
            logger.info(f"[pdf-vision] PDF has {num_pages} pages.")

            for page_idx in range(num_pages):
                page = src_doc[page_idx]
                logger.info(f"[pdf-vision] Processing page {page_idx + 1}/{num_pages}.")

                # 1) Render page to PNG bytes
                try:
                    png_bytes = self._page_to_png_bytes(page)
                except Exception as e:
                    logger.error(f"[pdf-vision] Failed to render page {page_idx + 1}: {e}")
                    # Create blank page with note
                    self._add_translated_page(
                        out_doc,
                        page.rect,
                        f"[Error rendering page {page_idx + 1}]",
                        page_idx,
                    )
                    continue

                # 2) Call vision model to get Spanish page text
                try:
                    translated_text = self.oai_client.translate_image_to_language(
                        png_bytes,
                        content_type="image/png",
                        target_language=target_language,
                        target_dialect=target_dialect,
                    )
                    if translated_text is None:
                        translated_text = ""
                except Exception as e:
                    logger.error(
                        f"[pdf-vision] Vision translation failed for page {page_idx + 1}: {e}"
                    )
                    translated_text = ""

                # Log a small sample so we know it's working
                if translated_text:
                    logger.info(
                        f"[pdf-vision sample] page {page_idx + 1}: "
                        f"{translated_text[:120]!r}"
                    )
                else:
                    logger.warning(
                        f"[pdf-vision] Empty translation for page {page_idx + 1}, "
                        f"creating blank page with placeholder."
                    )

                # 3) Add a new page with this translated text
                self._add_translated_page(
                    out_doc,
                    page.rect,
                    translated_text,
                    page_idx,
                )

            # Serialize new PDF to bytes
            buf = io.BytesIO()
            out_doc.save(buf)
            buf.seek(0)
            return buf.read()

        finally:
            src_doc.close()
            out_doc.close()
